# 智能标签功能实现工作清单

## 项目概述
实现基于大模型API的智能标签生成功能，通过提取和清洗网页内容，自动为收藏的书签生成合适的标签。

---

## 阶段一：基础架构搭建

### 1.1 权限配置
- [ ] 在 `manifest.json` 中添加 `scripting` 权限（用于动态注入脚本）
- [ ] 确保 `content_scripts` 配置正确（已配置 `<all_urls>`）
- [ ] 验证现有权限（`bookmarks`, `tabs`, `storage`）是否充足

### 1.2 文件结构创建
- [ ] 创建 `utils/` 目录（如果不存在）
- [ ] 创建 `utils/contentExtractor.js` - 页面内容提取模块
- [ ] 创建 `utils/contentCleaner.js` - 内容清洗模块
- [ ] 创建 `utils/aiLabelGenerator.js` - AI标签生成模块
- [ ] 创建 `utils/apiConfig.js` - API配置管理模块

---

## 阶段二：内容提取功能实现

### 2.1 修改 `content.js`
- [ ] 添加消息监听器，接收来自 background 的内容提取请求
- [ ] 实现 `extractPageContent()` 函数，提取页面DOM内容
  - [ ] 提取页面标题（`document.title`）
  - [ ] 提取 Meta 描述（`meta[name="description"]`）
  - [ ] 提取 Meta 关键词（`meta[name="keywords"]`）
  - [ ] 提取 Open Graph 标签
  - [ ] 提取主要文本内容（优先从 `main`, `article`, `[role="main"]` 获取）
  - [ ] 提取标题层级（`h1`, `h2`, `h3`）
  - [ ] 提取段落文本（`p` 标签）
  - [ ] 提取重要链接文本

### 2.2 实现 `utils/contentExtractor.js`
- [ ] 创建 `extractVisibleText()` 函数
  - [ ] 遍历 DOM 节点
  - [ ] 过滤隐藏元素（`display: none`, `visibility: hidden`, `hidden` 属性）
  - [ ] 提取可见文本节点
- [ ] 创建 `extractMainContent()` 函数
  - [ ] 优先查找 `main`, `article`, `[role="main"]` 标签
  - [ ] 查找常见内容类名（`.content`, `.main-content`, `.post`, `.article`）
  - [ ] 如果未找到，从 `<body>` 提取（排除导航、页脚等）
- [ ] 创建 `extractMetaInfo()` 函数
  - [ ] 提取所有 Meta 标签信息
  - [ ] 提取 Open Graph 数据
- [ ] 创建主函数 `extractPageContent()`，整合所有提取逻辑
- [ ] 添加错误处理和超时机制

---

## 阶段三：内容清洗功能实现

### 3.1 实现 `utils/contentCleaner.js`
- [ ] 创建 `removeUnnecessaryElements()` 函数
  - [ ] 删除 `<script>`, `<style>`, `<noscript>` 标签
  - [ ] 删除 HTML 注释
  - [ ] 删除隐藏元素
  - [ ] 删除导航、页脚、侧边栏元素（通过选择器排除）
  - [ ] 删除广告区域（`.ad`, `.advertisement` 等）
- [ ] 创建 `extractTextContent()` 函数
  - [ ] 合并相邻文本节点
  - [ ] 去除多余空白字符
  - [ ] 过滤过短文本（如单个字符）
- [ ] 创建 `limitContentLength()` 函数
  - [ ] 限制总文本长度为 3000-5000 字符
  - [ ] 实现优先级提取（标题 > 描述 > 主要内容前几段）
- [ ] 创建 `structureContent()` 函数
  - [ ] 保留段落结构
  - [ ] 保留标题层级信息
  - [ ] 提取列表项
- [ ] 创建主函数 `cleanContent(htmlContent)`，整合所有清洗逻辑
- [ ] 返回结构化的内容对象（包含 title, description, content, headings 等）

---

## 阶段四：API配置管理

### 4.1 实现 `utils/apiConfig.js`
- [ ] 创建 `getApiConfig()` 函数
  - [ ] 从 `chrome.storage.local` 读取API配置
  - [ ] 返回配置对象（endpoint, apiKey, model, temperature 等）
- [ ] 创建 `saveApiConfig()` 函数
  - [ ] 保存API配置到 `chrome.storage.local`
  - [ ] 对 API Key 进行加密存储（可选）
- [ ] 创建 `validateApiConfig()` 函数
  - [ ] 验证配置是否完整
  - [ ] 验证 API Key 格式（如果可验证）

### 4.2 在 `options/option.html` 添加配置界面
- [ ] 在侧边栏添加新项“API设置”或添加到现有设置区域
- [ ] 创建API配置表单
  - [ ] API端点输入框
  - [ ] API Key 输入框（密码类型）
  - [ ] 模型选择下拉框（或输入框）
  - [ ] 温度参数滑块（可选）
  - [ ] 保存/测试按钮
- [ ] 添加配置说明文字

### 4.3 在 `options/option.js` 添加配置逻辑
- [ ] 实现加载API配置到表单
- [ ] 实现保存API配置
- [ ] 实现测试API连接功能（可选）
- [ ] 添加表单验证

---

## 阶段五：AI标签生成功能

### 5.1 实现 `utils/aiLabelGenerator.js`
- [ ] 创建 `buildPrompt()` 函数
  - [ ] 接收清洗后的内容对象
  - [ ] 接收已有标签（如果有）
  - [ ] 构建格式化的 prompt 文本
  - [ ] 包含标题、描述、主要内容、已有标签等信息
- [ ] 创建 `callAIApi()` 函数
  - [ ] 读取API配置
  - [ ] 构建API请求（支持 OpenAI、Claude 等常见格式）
  - [ ] 发送HTTP请求
  - [ ] 处理响应和错误
  - [ ] 设置超时机制（10秒）
- [ ] 创建 `parseTags()` 函数
  - [ ] 从API响应中提取标签
  - [ ] 解析“#标签1 #标签2 #标签3”格式
  - [ ] 验证标签格式
  - [ ] 去重和过滤无效标签
- [ ] 创建主函数 `generateSmartTags(bookmarkId, pageContent)`
  - [ ] 整合 prompt 构建、API调用、响应解析
  - [ ] 保存生成的标签到 `chrome.storage.local`
  - [ ] 返回生成的标签数组

### 5.2 支持多种API格式
- [ ] OpenAI API 格式支持
- [ ] Anthropic Claude API 格式支持
- [ ] 通用 REST API 格式支持（可配置请求格式）
- [ ] 本地模型API支持（如 ollama 等）

---

## 阶段六：Background服务集成

### 6.1 修改 `background.js`
- [ ] 在 `chrome.bookmarks.onCreated` 监听器中添加智能标签生成逻辑
  - [ ] 获取当前活动标签页
  - [ ] 检查标签页URL（确保是 http/https）
  - [ ] 发送消息到 content script 获取页面内容
  - [ ] 接收清洗后的内容
  - [ ] 调用AI标签生成功能
  - [ ] 保存生成的标签
  - [ ] 更新 popup 显示（如果已打开）
- [ ] 添加错误处理
  - [ ] 内容提取失败时的降级方案（仅使用标题和URL）
  - [ ] API调用失败时的提示
- [ ] 添加超时处理（10秒超时）
- [ ] 实现内容缓存机制（相同URL的页面内容缓存）

### 6.2 消息通信
- [ ] 定义消息类型常量
  - [ ] `EXTRACT_PAGE_CONTENT` - 提取页面内容
  - [ ] `PAGE_CONTENT_EXTRACTED` - 页面内容提取完成
  - [ ] `GENERATE_SMART_TAGS` - 生成智能标签
- [ ] 在 `background.js` 和 `content.js` 之间建立消息传递机制

---

## 阶段七：UI界面集成

### 7.1 修改 `popups/popup.html` 和 `popups/popup.js`
- [ ] 在popup中添加“智能生成标签”按钮
- [ ] 添加加载状态显示（“正在分析页面内容...”）
- [ ] 添加生成结果展示区域
  - [ ] 显示生成的标签建议
  - [ ] 允许用户选择性地添加标签
- [ ] 实现按钮点击事件
  - [ ] 调用 background 的智能标签生成功能
  - [ ] 显示加载动画
  - [ ] 更新标签显示

### 7.2 修改 `options/option.html` 和 `options/option.js`
- [ ] 在“所有书签”页面的每个书签卡片中添加“智能生成标签”按钮
  - [ ] 按钮可以放在“编辑标签”旁边或标签区域内
- [ ] 实现按钮点击事件
  - [ ] 获取书签的URL
  - [ ] 如果书签对应的标签页仍打开，提取当前页面内容
  - [ ] 如果标签页已关闭，提示用户或使用缓存的内容
  - [ ] 调用智能标签生成功能
  - [ ] 更新标签显示
- [ ] 添加批量生成功能（可选）
  - [ ] 为多个书签批量生成标签

### 7.3 样式调整
- [ ] 在 `popups/popup.css` 中添加“智能生成标签”按钮样式
- [ ] 在 `options/option.css` 中添加相关样式
- [ ] 添加加载动画样式
- [ ] 添加生成结果展示区域样式

---

## 阶段八：用户体验优化

### 8.1 加载状态提示
- [ ] 在popup中显示“正在分析页面内容...”
- [ ] 在“所有书签”页面显示加载提示
- [ ] 添加进度指示器（如果可能）

### 8.2 错误处理与提示
- [ ] API配置缺失时的提示
- [ ] API调用失败时的错误提示
- [ ] 内容提取失败时的降级提示
- [ ] 网络超时的提示

### 8.3 缓存优化
- [ ] 实现页面内容缓存（URL作为key）
- [ ] 实现生成结果缓存（相同URL的标签建议可复用）
- [ ] 添加缓存过期机制（可选）

### 8.4 隐私提示
- [ ] 首次使用时显示隐私说明
- [ ] 说明会将页面内容发送到API
- [ ] 提供同意/拒绝选项

---

## 阶段九：测试与调试

### 9.1 功能测试
- [ ] 测试内容提取功能（不同类型网站）
- [ ] 测试内容清洗功能
- [ ] 测试API调用功能
- [ ] 测试标签解析功能
- [ ] 测试完整流程（收藏 -> 提取内容 -> 生成标签）

### 9.2 边界情况测试
- [ ] 测试空页面
- [ ] 测试单页应用（SPA）
- [ ] 测试需要登录的页面
- [ ] 测试API调用失败情况
- [ ] 测试超时情况
- [ ] 测试无效API Key

### 9.3 性能测试
- [ ] 测试大页面内容的提取速度
- [ ] 测试API调用响应时间
- [ ] 测试内存使用情况

---

## 阶段十：文档与优化

### 10.1 代码优化
- [ ] 代码注释完善
- [ ] 函数命名优化
- [ ] 错误处理完善
- [ ] 代码重构（如需要）

### 10.2 文档编写
- [ ] 编写用户使用说明
- [ ] 编写API配置说明
- [ ] 编写开发者文档（可选）

### 10.3 最终检查
- [ ] 检查所有功能是否完整
- [ ] 检查UI/UX是否流畅
- [ ] 检查错误处理是否完善
- [ ] 检查代码是否有lint错误

---

## 技术要点总结

### 关键技术
1. **Content Script 消息通信**：`chrome.tabs.sendMessage` / `chrome.runtime.onMessage`
2. **DOM 提取**：遍历 DOM 树，提取可见文本
3. **内容清洗**：正则表达式、DOM 操作、文本处理
4. **API 调用**：Fetch API、错误处理、超时控制
5. **数据存储**：`chrome.storage.local` 存储配置和缓存

### 注意事项
- 所有操作需要异步处理，避免阻塞UI
- 需要处理各种边界情况和错误
- 注意隐私保护，明确告知用户数据使用情况
- API Key 需要安全存储
- 内容提取可能受到 CSP 限制，需要处理异常

### 可选增强功能
- [ ] 支持标签推荐（基于已有标签）
- [ ] 支持标签学习（记录用户偏好）
- [ ] 支持多语言标签生成
- [ ] 支持批量处理多个书签
- [ ] 支持自定义 prompt 模板
- [ ] 支持本地模型（Web LLM）

---

## 优先级建议

**高优先级（核心功能）：**
- 阶段一、二、三、五、六（基础架构和核心功能）

**中优先级（用户体验）：**
- 阶段四、七、八（配置界面和UI集成）

**低优先级（优化）：**
- 阶段九、十（测试和文档）

---

*最后更新时间：2024年*
